---
title: "DataViz Makeover"
editor: visual
date:  23 Jan 2023
date-modified: "`r Sys.Date()`"
code-copy: true
execute: 
  echo: true
  eval: true
  warning: false
website: 
    google-analytics: "G-PKMQ2W4ZRC"
format:
  html:
    code-overflow: wrap
    code-fold: true
    code-summary: "Show the code"
    css: styles.css
---

# **1. OVERVIEW**

There are two main focuses for this makeover assignment, that is :

1.  Critic or feedback on the trellis plot of 9 population pyramids created by a fellow coursemate, [Chen Yi Man](https://public.tableau.com/app/profile/yiman.chen/viz/takehome_ex01/Story1), with consent.
2.  Remake and refine the trellis plot with an alternative design based on the principles and best practices learned in Lessons 1 and 2, using R packages, specifically ggplot2, ggplot2 extensions and tidyverse packages.

::: {.callout-tip collapse="true" appearance="simple" icon="false"}
## [**Requirement Details for this Individual Assignment**]{style="color:#3a9c88"}

-   select one of the Take-home Exercise 1 prepared by your classmate,

-   critic the submission in terms of clarity and aesthetics,

-   prepare a sketch for the alternative design by using the data visualisation design principles and best practices you had learned in Lesson 1 and 2, and remake the original design by using ggplot2, ggplot2 extensions and tidyverse packages.

[The purpose of DataVis Makeover is to improve on the original visualisation. Focus on what works, what doesn't work, why those things don't work, and how you made it better. You should try stick to the fields in the data set provided and improve upon the original visualisation.]{style="color:#d69c3c"}
:::

## **1.1 Review Original Chart**

::: {.callout-warning appearance="simple" icon="false"}
There are two main instructions for the first take-home exercise, which are to reveal the demographic structure of Singapore at the planning area level by using the age-sex pyramid method and displaying 9 selected planning areas on a single view.

For this section, the review will be based on clarity and aesthetics.

### Highlights of Exceptional Elements

Within a short amount of time (less than a week), for a person totally new to Tableau, she was able to deliver an inspiring piece of work in the following aspects :

-   Three (3) different depths - an overview of Singapore at a national level, followed by Singapore Planning Areas (PAs) and Sub Zones for each PA.

-   Compliment the storytelling with a degree of geospatial visual analysis.

-   Provide interactive features that facilitate visual analysis of the topic.

[![Figure 1.1 Landing view with an overview of Singapore Population Pyramid.](images/image-30154142.png){fig-alt="This image illustrate an overview of Singapore Population Pyramid that produced by Tableau Desktop." fig-align="left" width="400"}](https://public.tableau.com/shared/FRQBJR92T?:display_count=n&:origin=viz_share_link)

[![Figure 1.2 Display trellis plot of Singapore Population Pyramids by 55 Planning Area.](images/image-1612659243.png){fig-alt="This image illustrate the population pyramid for 55 Planning Area." fig-align="left" width="400"}](https://public.tableau.com/shared/FRQBJR92T?:display_count=n&:origin=viz_share_link)

[![Figure 1.3 Display trellis plot of Singapore Population Pyramids by subzone.](images/image-101707983.png){fig-alt="This image illustrate the population pyramid for all sub-zones within each 55 Singapore Planning Areas." fig-align="left" width="400"}](https://public.tableau.com/shared/HG56JW8NK?:display_count=n&:origin=viz_share_link)

### **Rooms for Improvement**

However, in terms of clarity and aesthetic aspects, there are four (4) main rooms for improvement :

#### **a. Lack of clarity**

+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| what doesn't work                                                                                                                                                                   | feedback                                                                                                                                   | suggestion                                                                                                                         |
+=====================================================================================================================================================================================+============================================================================================================================================+====================================================================================================================================+
| Choice of words for the title.                                                                                                                                                      | The title is not conveying clear context.                                                                                                  | Suggest stating the key focus upfront.                                                                                             |
|                                                                                                                                                                                     |                                                                                                                                            |                                                                                                                                    |
| "Discovering Singapore Age Pyramid: Sex Pattern in Jun 2022"                                                                                                                        | -   Readers may be mislead into the notion of this chart is based on age-related variable with sex-related value as the response variable. | -   In this study, the key focus is the pattern, then followed by the supporting details such as the variables, location and time. |
|                                                                                                                                                                                     | -   The confusion is further enhanced by the colon character " : ".                                                                        | -   For example, "Discover Patterns of Age and Gender distribution in Singapore as of June 2022".                                  |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| The sequence of additional storyboards (landing storyboard consists of a Singapore map and a population pyramid, while the last storyboard consists of a trellis plot by sub-zones. | The entire approach may distract readers from the trellis plot of 9 selected PAs, which should be the main focus.                          | Perhaps can reduce the storyboards to two, meaning :                                                                               |
|                                                                                                                                                                                     |                                                                                                                                            |                                                                                                                                    |
|                                                                                                                                                                                     |                                                                                                                                            | -   Combine both overview and the trellis plot of 9 selected PAs into a storyboard                                                 |
|                                                                                                                                                                                     |                                                                                                                                            |                                                                                                                                    |
|                                                                                                                                                                                     |                                                                                                                                            | -   The storyboard of the trellis for subzones can remains the same.                                                               |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------+

#### **b. Trellis layout of 55 PAs**

+--------------------------------------+-----------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------+
| what doesn't work                    | feedback                                                                                                              | suggestion                                                                          |
+======================================+=======================================================================================================================+=====================================================================================+
| Display 55 PAs' population pyramids. | For a static plot, readers won't be able to view 55 PA's population pyramids plotted diagonally within a single view. | First, filter 9 PAs by context before plotting them into a single view.             |
|                                      |                                                                                                                       |                                                                                     |
|                                      | Even if it's an interactive plot, a filter of 9 PAs should have been provided to the readers.                         | -   For example, the top 9 highest population count or the gender-population count. |
+--------------------------------------+-----------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------+

#### **c. Lack of Visual Cues or Display by Context**

+-----------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| what doesn't work                                                           | feedback                                                                                                                                                                      | suggestion                                                                                                                                                             |
+=============================================================================+===============================================================================================================================================================================+========================================================================================================================================================================+
| Single colour for 2 different values, "Males" and "Females".                | Unless viewed from 15-inch laptops or a bigger monitor screen, a reader can only identify which side of the bars represents males or females after scrolling down the screen. | Assign 2 different colours for the gender variable.                                                                                                                    |
+-----------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Age group is showing "Null" value, and grouped age into 10 years intervals. | No caption or note to clarify "Null" value.                                                                                                                                   | For demographic structure, should use quinquennial age groups (grouped age in 5 years intervals).                                                                      |
|                                                                             |                                                                                                                                                                               |                                                                                                                                                                        |
|                                                                             | Context is not clear why the age is grouped into 10 years.                                                                                                                    | -   Click [here](https://visual-analytics-jephostan.netlify.app/takehome/th_ex1/th_ex1#bins-of-age-group) to find out more about ages grouping for different contexts. |
+-----------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
:::

## **1.2 Proposal for Alternative Design**

### **1.2.1 Sketch for Alternate Design**

::: {.callout-warning appearance="simple" icon="false"}
![Figure 1.4 Proposal for Alternative Design](images/image-1080407652.png){fig-alt="This image illustrate a sketch that consists of trellis plot with wrap facet and a data table placed below." fig-align="left" width="800"}

Remarks :

This proposal sketch is done with **Figma** web-tool.
:::

### **1.2.1 Clarity Enhancement**

::: {.callout-warning appearance="simple" icon="false"}
***a. Context*** **:** The proposed design will inherit the context requirement from the first Take-home assignment, which is to reveal Singapore's demographic structure with two key variables : age-groups and gender as of June 2022. It will be a trellis plot of population pyramids with wrap facet 3 by 3. The top 9 Singapore Planning Areas with the highest population counts.

***b. Title & Subtitle*** **:** The proposed design has a title consisting of the main subject, supporting details and location, while the variables and time will be under the subtitle.

***c.X-axis Label*** **:** Only show the x-axis title below the chart. The population count value will be hidden as the proportion of values to bars are too huge to be meaningful. Should the readers interested to learn more about the figures, they can refer to the data table that presenting below the plot.

***d. Y-axis Title & Text*** **:** Y-axis title will be displayed above the axis instead of next to the value. The age-group values will need to be sorted with the oldest at the top.

***e. Legend*** **:** Only the genders' values will be displayed, which are "Males" and "Females".

***f. Caption*** **:** It will state the data source and the year of data obtained.
:::

### **1.2.2 Aesthetic Enhancement**

::: {.callout-warning appearance="simple" icon="false"}
***a. X-axis labels*** **:** Only the x-axis title is shown to minimise clustering the chart with figures.

***b. Tick marks & background border lines*** **:** The colours thereof will be "mid-grey" to focus readers more on the bars.

***c. Gridlines*** : Only display horizontal grid lines since identifying the bars' length from a static plot is not practical.

***(d) Colour*** : A pair of high-contrast colours will be assigned to the gender values. Titles and subtitles will be in various shades of grey.

***(e) Font size:*** The font size of the main title will be more prominent than the sub-title. This will help to set the reader's focus on the right context when analysing the chart.
:::

# **2. R PACKAGE REQUIRED**

The following are the packages required for this exercise :

## **2.1 Load R Packages**

::: {.callout-warning appearance="simple" icon="false"}
[Usage of the code chunk below :]{style="color:#a39f9d"}

[***p_load( )*** - pacman -]{style="color:#d46e15"} to load packages into R environment. This function will attempt to install the package from CRAN or pacman repository list if it is not installed.

```{r}
pacman::p_load(tidyverse, ggpubr, readxl, knitr, plotly, skimr, questionr, funModeling, ggplot2, sf, tmap, quanteda, NLP, patchwork, ggpmisc, gridExtra, kableExtra)
```
:::

# **3. DATA**

## **3.1 Acquire Data Source**

::: {.callout-warning appearance="simple" icon="false"}
This study will be based on demographic data set downloadable from [Singstat.gov.sg](https://www.singstat.gov.sg/find-data/search-by-theme/population/geographic-distribution/latest-data).

-   Download "Singapore Residents by Planning Area Subzone, Age Group, Sex and Type of Dwelling, June 2022" in CSV format.

::: {.callout-tip collapse="true" appearance="simple" icon="false"}
## [**Highlights of the data set**]{style="color:#3a9c88"}

1.  Data may not add up due to rounding.

2.  For June 2022, Planning Areas refer to areas demarcated in the Urban Redevelopment Authority's Master Plan 2019.

3.  Data from 2003 onwards exclude residents who have been away from Singapore for a continuous period of 12 months or longer as at the reference period.

4.  Metadata :

    -   PA = Planning Area

    -   SZ = Subzone

    -   AG = Age Group

    -   Sex = Sex

    -   TOD = Type of Dwelling

    -   Pop = Resident Count

    -   Time - Time / Period
:::
:::

## **3.2 Import Data**

### **3.2.1 Import Attributes Data**

::: {.callout-warning .column-page-right appearance="simple" icon="false"}
There are two (2) steps involve, which are import and inspect imported data set.

#### **3.2.1.1 import data**

::: {.callout-alert appearance="simple" icon="false"}
[Usage of the code chunk below :]{style="color:#a39f9d"}

[***read_csv( )*** - readr -]{style="color:#d46e15"} to read CSV file into a tibble.

[***problems( )*** - readr -]{style="color:#d46e15"} to reveal any parsing errors when importing the CSV file.
:::

```{r}
pop_attribute <- read_csv("data/aspatial/respopagesextod2022.csv")

problems(pop_attribute)
```

#### **3.2.1.2 inspect missing value**

```{r}
skimr::skim(pop_attribute)
```

#### **3.2.1.3 inspect values**

```{r}
#| code-fold: false
unique(pop_attribute$Time)
```

```{r}
unique(pop_attribute$TOD)
```

Remarks :

Can remove "SZ", "Time" and "TOD" fields as they are not needed for age-sex population pyramids.
:::

## **3.3 Data Wrangling**

### **3.3.1 Change Field Names to Lowercase**

::: {.callout-warning appearance="simple" icon="false"}
To avoid confusion between field names used in data and discussions, change all fields' name to lowercase.

::: {.callout-alert appearance="simple" icon="false"}
[Usage of the code chunk below :]{style="color:#a39f9d"}

[***tolower( )*** - quanteda -]{style="color:#d46e15"} to convert fields' name into lower case.
:::

```{r}
#| code-fold: false
names(pop_attribute) <- tolower(names(pop_attribute))
```
:::

### **3.3.2 Remove Non-Alphameric Character**

::: {.callout-warning appearance="simple" icon="false"}
There are special character such as "\_" among the Age Groups' values.

Unable to use str_sub( ) function from stringr package as the position of "\_" is varied among values.

::: {.callout-alert appearance="simple" icon="false"}
[Usage of the code chunk below :]{style="color:#a39f9d"}

[***gsub( )*** - base -]{style="color:#d46e15"} to replace "\_" with space " ".
:::

```{r}
#| code-fold: false
pop_attribute$ag <- gsub("_", 
                         " ", 
                         pop_attribute$ag, 
                         fixed = TRUE)
```
:::

## **3.4 Group Variables**

Before grouping the entire data frame, first tested with a single Planning Area.

### **3.4.1 Explore with a Planning Area :: Bedok**

::: {.callout-warning appearance="simple" icon="false"}
::: {.callout-alert appearance="simple" icon="false"}
[Usage of the code chunk below :]{style="color:#a39f9d"}

[***group_by( )*** - dplyr -]{style="color:#d46e15"} to group Singapore population by age and gender.

[***summarise( )*** - dplyr -]{style="color:#d46e15"} to count the number of residents for each group.
:::

```{r}
#| code-fold: false
test0 <- pop_attribute %>% 
  filter(pa == "Bedok") %>%
  group_by(ag, sex) %>%
  summarise(`count_pop` = sum(`pop`)) %>%
  ungroup()
```
:::

### **3.4.2 Visualise Data**

::: {.callout-warning appearance="simple" icon="false"}
::: panel-tabset
## Visualise Bedok Data

```{r}
ggplot(data = test0,
       aes(y = ag)) +
  geom_bar() +
  theme_bw() +  
  ggtitle("Test Age Group Distribution") 
```

## Inspect Data

```{r}
unique(pop_attribute$ag)
```
:::

::: panel-tabset
Remarks :

Notice the age group "5 to 9" is placed after "45 to 49" instead of placed at the 2nd value as shown under the "Inspect Data" tab.
:::
:::

### **3.4.3 Update Sequence of Age Groups Display**

::: {.callout-warning appearance="simple" icon="false"}
The update will be applied to 2 datasets, at national level and Planning Areas level.

#### **3.4.3.1 For Population Pyramid at National Level**

::: {.callout-alert appearance="simple" icon="false"}
[Usage of the code chunk below :]{style="color:#a39f9d"}

[***arrange( )*** - dplyr -]{style="color:#d46e15"} to sort the rows in descending order of the counted "Returned" value of each "Sub-category".
:::

```{r}
ag_sequence <- c("0 to 4", "5 to 9", "10 to 14", "15 to 19", "20 to 24", "25 to 29", "30 to 34", "35 to 39", "40 to 44", "45 to 49", "50 to 54", "55 to 59", "60 to 64", "65 to 69", "70 to 74", "75 to 79", "80 to 84", "85 to 89", "90 and over")

pop_sgp <- pop_attribute %>%
  group_by(ag, sex) %>%
  summarise(`count_pop` = sum(`pop`)) %>%
  mutate(ag = factor(ag, levels = ag_sequence)) %>%
  arrange(ag) %>%
  ungroup()

pop_sgp <- pop_sgp %>%
  mutate(pct = scales::percent((count_pop/sum(count_pop)), accuracy = 0.01),
         res = str_c(count_pop, ", ", pct))

```

#### **3.4.3.2** **For Population Pyramid at Planning Area level**

```{r}
#| code-fold: false
ag_sequence <- c("0 to 4", "5 to 9", "10 to 14", "15 to 19", "20 to 24", "25 to 29", "30 to 34", "35 to 39", "40 to 44", "45 to 49", "50 to 54", "55 to 59", "60 to 64", "65 to 69", "70 to 74", "75 to 79", "80 to 84", "85 to 89", "90 and over")

pop_pa <- pop_attribute %>%
  group_by(pa, ag, sex) %>%
  summarise(`count_pop` = sum(`pop`)) %>%
  mutate(ag = factor(ag, levels = ag_sequence)) %>%
  arrange(ag) %>%
  ungroup()

pop_pa <- pop_pa %>%
  mutate(pct = scales::percent((count_pop/sum(count_pop)), accuracy = 0.01),
         res = str_c(count_pop, ", ", pct))
```
:::

## **3.5 Create 9 Planning Areas Data Set**

### **3.5.1 Create List of Planning Areas by Population**

::: {.callout-warning appearance="simple" icon="false"}
Filter top 9 Planning Areas based on the highest population.

::: {.callout-alert appearance="simple" icon="false"}
[Usage of the code chunk below :]{style="color:#a39f9d"}

[***slice( )*** - dplyr -]{style="color:#d46e15"} to filter based on the first 9 rows.
:::

```{r}
#| code-fold: false
pop_paList <- pop_attribute %>%
  group_by(pa) %>%
  summarise(`count_pop` = sum(`pop`)) %>%
  ungroup()

t3 <- arrange(pop_paList, desc(pop_paList$count_pop)) %>%
  slice(1:3) %>%
  select(pa)
  
t6 <- arrange(pop_paList, desc(pop_paList$count_pop)) %>%
  slice(4:6) %>%
  select(pa)
  
t9 <- arrange(pop_paList, desc(pop_paList$count_pop)) %>%
  slice(7:9) %>%
  select(pa)

t19 <- arrange(pop_paList, desc(pop_paList$count_pop)) %>%
  slice(1:9) %>%
  select(pa)
```

[Remarks :]{style="color:#d69c3c"}

-   [t19 will be used to plot 9 population pyramids.]{style="color:#d69c3c"}

-   [Once t3, t6 and t9 are plotted, they will be stacked together to compare the differences with the t19 plot.]{style="color:#d69c3c"}
:::

### **3.5.2 Filter Planning Areas**

::: {.callout-warning appearance="simple" icon="false"}
Filter data frame based on the list of Planning Areas created in section **3.5.1**.

```{r}
#| code-fold: false
t3_filtered <- pop_pa %>% 
  filter(pop_pa$pa %in% t3$pa) %>%
  arrange(factor(pa, 
                 levels = c("Bedok", "Tampines", "Jurong West")))

t6_filtered <- pop_pa %>% 
  filter(pop_pa$pa %in% t6$pa)

t9_filtered <- pop_pa %>% 
  filter(pop_pa$pa %in% t9$pa)

t19_filtered <- pop_pa %>% 
  filter(pop_pa$pa %in% t19$pa) 

```
:::

# **4. DATA VISUALISATION**

## **4.1 Plot Pyramid Chart (Static Plot)**

### **4.1.1 Plot Population Pyramid for National Level**

::: {.callout-warning appearance="simple" icon="false"}
::: {.callout-alert appearance="simple" icon="false"}
[Usage of the code chunk below :]{style="color:#a39f9d"}

[***geom_col( )*** - ggplot2 -]{style="color:#d46e15"} to create the bar chart with the bar length represent the actual population stats.

[***scale_x\_continuous( )*** - ggplot2 -]{style="color:#d46e15"} to modify the labels on the x-axis to provide better readability.

[***ifelse( )*** - base -]{style="color:#d46e15"} to convert population count of Male residents to be negative, so that their data will be plotted on the left side of the pyramid.
:::

```{r}
popPyr_sgp <- ggplot(pop_sgp, 
                       aes(x = ifelse(sex == "Males",
                                      yes = -count_pop,
                                      no = count_pop),
                           y = ag,
                           fill = sex)) + 
  geom_col() +
  scale_x_continuous(limits = c(-170000, 170000),
    breaks = seq(-200000, 200000, 50000), 
                     labels = paste0(
                       as.character(
                         c(seq(200, 0, -50), 
                           seq(50, 200, 50))),
                       "k")) +
  scale_y_discrete(expand = expansion(mult = c(0, .04))) +
  labs (x = "Count of Population", 
        y = "Age Group",
        fill = "Gender",
        title = "Demographic Structure of Singapore",
        subtitle = "the shape of population pyramid reflects the distribution of\npopulation by age groups and genders based on dataset dated June 2022",
        caption = "Data Source : Singstat.gov.sg, June 2022") +
  theme_bw() +
  theme(plot.title = element_text(size = 14, 
                                  colour = "#302f2f",
                                  face = "bold",
                                  hjust = 0.5),
        plot.subtitle = element_text(size = 8,
                                     colour = "#424242",
                                     face = "italic",
                                     hjust = 0.5),
        plot.caption = element_text(size = 8,
                                    colour = "#424242",
                                    hjust = 0),
        axis.ticks = element_line(colour = "#969595",
                                  linewidth = 0.3),
        axis.title.y = element_text(angle = 0, 
                                    size = 8, 
                                    colour = "#302f2f",
                                    vjust = 1.07,
                                    hjust = 1,
                                    margin = margin(r = -50, l = 10)),
        axis.title.x = element_text(size = 8, 
                                    colour = "#302f2f"),
        axis.text.x = element_text(size = 7,
                                   colour = "#424242"),
        axis.text.y = element_text(size = 7,
                                   colour = "#424242"),
        legend.position = "bottom",
        legend.justification = "left",
        legend.text = element_text(size = 7,
                                   colour = "#424242"),
        legend.title = element_text(size = 8,
                                    colour = "#302f2f"),
        panel.grid.major.y = element_line(linewidth = rel(0.5)),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill = "#f7e9cd"),
        legend.background = element_rect(fill = "#f7e9cd"),
        legend.margin = margin(t = -10),
        panel.border = element_rect(colour = "#969595",
                                    linewidth = 0.3)) +
  geom_text(aes(label = pct),
            hjust = ifelse(pop_sgp$sex == "Males",
                           yes = 1.2, 
                           no = -0.2),
            size = 2,
            check_overlap = FALSE,
            colour = "#424242") +
  scale_fill_manual(values = c("Males" = "#FFA319FF", 
                               "Females" = "#302f2f"))

popPyr_sgp
```

[Remark :]{style="color:#d69c3c"}

[The pyramid above shows the younger generation's lower percentage, making Singapore's population structure a constrictive type. That means an ageing population.]{style="color:#d69c3c"}

[By June 2022, 4.07 million residents population with a median age of 42.1,]{style="color:#d69c3c"}[^1] [which is approximately a 19% increase from the median age of 35.3 back in the year 2002]{style="color:#d69c3c"}[^2].

[Also, another observation is from 25 age onward, the female population is higher than the male population.]{style="color:#d69c3c"}

[As of 2020, Singapore's adjusted gender pay gap (GPG) is at 6%]{style="color:#d69c3c"}[^3]. [Measures and new schemes may be required to further narrow the gender pay gap and encourage the birth rate or may have long-lasting socio-economic repercussions.]{style="color:#d69c3c"}
:::

[^1]: [Singstat. (2022). Population Dashboard. https://www.singstat.gov.sg/find-data/search-by-theme/population/population-and-population-structure/visualising-data/population-dashboard]{style="color:#d69c3c"}

[^2]: [Singstat. (2002). Indicators On Population. https://tablebuilder.singstat.gov.sg/table/TS/M810001]{style="color:#d69c3c"}

[^3]: [Ministry of Manpower. (2020). Report: Singapore's Adjusted Gender Pay Gap. https://stats.mom.gov.sg/Pages/Singapores-Adjusted-Gender-Pay-Gap.aspx]{style="color:#d69c3c"}

### **4.1.2 Plot Trellis Population Pyramid with Wrap Facet**

::: {.callout-warning appearance="simple" icon="false"}
```{r}
#| fig-height: 12
#| fig-width: 12
popPyr_t19.fw <- ggplot(t19_filtered, 
                       aes(x = ifelse(sex == "Males",
                                      yes = -count_pop,
                                      no = count_pop),
                           y = ag,
                           fill = sex),
                     width = 0.9,
                     position = position_dodge(width = 0.9 )) + 
  geom_col() +
  scale_y_discrete(expand = expansion(mult = c(0.04, .04))) +
  facet_wrap(~factor(pa, levels = c("Bedok", "Tampines", "Jurong West",
                                    "Sengkang", "Woodlands", "Hougang",
                                    "Yishun", "Choa Chu Kang", "Punggol")),
             drop = FALSE, 
             ncol = 3,
             scales = "fixed") +
  labs (x = "Count of Population", 
        y = "Age Group",
        fill = "Gender",
        title = "Singapore Demographic Structure - Top 9 Planning Areas by Population",
        subtitle = "Compare the population pyramids' shapes that shows the distribution of age groups & genders based on dataset dated June 2022",
        caption = "Data Source : Singstat.gov.sg, June 2022\nThe details of the population count for each age-groups and gender are tabulated below.") +
  theme_bw() +
  theme(plot.title = element_text(size = 22, 
                                  colour = "#302f2f",
                                  face = "bold"),
        plot.subtitle = element_text(size = 12,
                                     colour = "#424242",
                                     face = "italic",
                                     margin = margin(0,0,10,0)),
        plot.caption = element_text(size = 10,
                                    colour = "#424242",
                                    hjust = 0),
        strip.text = element_text(size = 12,
                                  face = "bold",
                                  colour = "#424242"),
        strip.background = element_blank(),
        axis.ticks = element_line(colour = "#969595",
                                  linewidth = 0.3),
        axis.ticks.x = element_blank(),
        axis.title.y = element_text(angle = 0, 
                                    size = 10,
                                    colour = "#302f2f",
                                    vjust = 1.02,
                                    margin = margin(r = -50, l = 20)),
        axis.title.x = element_text(size = 10,
                                    colour = "#302f2f",
                                    margin = margin(5,0,0,0)),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 10,
                                   colour = "#424242",
                                   margin = margin(r = 8)),
        panel.grid.major = element_line(linewidth = rel(0.5)),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill = "#f7e9cd"),
        plot.margin = margin(1,0.8,1,0,"cm"),
        panel.border = element_rect(colour = "#969595",
                                    linewidth = 0.3),
        legend.title = element_text(size = 10,
                                    colour = "#302f2f"),
        legend.text = element_text(size = 10,
                                   face = "bold",
                                   colour = "#424242"),
        legend.background = element_rect(fill = "#f7e9cd"),
        legend.margin = margin(t = -8),
        legend.position = "bottom",
        legend.justification = "left") +
  scale_fill_manual(values = c("Males" = "#FFA319FF",
                               "Females" = "#302f2f"))

popPyr_t19.fw
```
:::

### **4.1.3** **Plot Trellis Population Pyramid with Grid Facet**

::: {.callout-warning appearance="simple" icon="false"}
```{r}
#| fig-height: 8
#| fig-width: 20
popPyr_t19.fg <- ggplot(t19_filtered, 
                       aes(x = ifelse(sex == "Males",
                                      yes = -count_pop,
                                      no = count_pop),
                           y = ag,
                           fill = sex),
                     width = 0.9,
                     position = position_dodge(width = 0.9 )) + 
  geom_col() +
  scale_y_discrete(expand = expansion(mult = c(0, .05))) +
  scale_fill_manual(
    values = c("Males" = "#FFA319FF",
               "Females" = "#302f2f"),
    breaks = c("Males", "Females")) +
  facet_grid(~factor(pa, levels = c("Bedok", "Tampines", "Jurong West",
                                    "Sengkang", "Woodlands", "Hougang",
                                    "Yishun", "Choa Chu Kang", "Punggol"))) +
  labs (x = "Count of Population", 
        y = "Age Group",
        fill = "Gender",
        title = "Singapore Demographic Structure - Top 9 Planning Areas by Population",
        subtitle = "Compare the population pyramids' shapes that shows the distribution of age groups & genders based on dataset dated June 2022",
        caption = "Data Source : Singstat.gov.sg, June 2022\nThe details of the population count for each age-groups and gender are tabulated below.") +
  theme_bw() +
  theme(plot.title = element_text(size = 22, 
                                  colour = "#302f2f",
                                  face = "bold"),
        plot.subtitle = element_text(size = 12,
                                     colour = "#424242",
                                     face = "italic",
                                     margin = margin(0,0,10,0)),
        plot.caption = element_text(size = 10,
                                    colour = "#424242",
                                    hjust = 0),
        strip.text = element_text(size = 12,
                                  face = "bold",
                                  colour = "#424242"),
        strip.background = element_blank(),
        axis.ticks = element_line(colour = "#969595",
                                  linewidth = 0.3),
        axis.ticks.x = element_blank(),
        axis.title.y = element_text(angle = 0, 
                                    size = 10,
                                    colour = "#302f2f",
                                    vjust = 1.02,
                                    margin = margin(r = -50, l = 20)),
        axis.title.x = element_text(size = 10,
                                    colour = "#302f2f",
                                    margin = margin(5,0,0,0)),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 10,
                                   colour = "#424242",
                                   margin = margin(r = 8)),
        panel.grid.major = element_line(linewidth = rel(0.5)),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill = "#f7e9cd"),
        plot.margin = margin(1,0.8,1,0,"cm"),
        panel.border = element_rect(colour = "#969595",
                                    linewidth = 0.3),
        legend.title = element_text(size = 10,
                                    colour = "#302f2f"),
        legend.text = element_text(size = 10,
                                   face = "bold",
                                   colour = "#424242"),
        legend.background = element_rect(fill = "#f7e9cd"),
        legend.margin = margin(t = -8),
        legend.position = "bottom",
        legend.justification = "left") +
  scale_fill_manual(values = c("Males" = "#FFA319FF",
                               "Females" = "#302f2f"))
  
popPyr_t19.fg
```

[Remark :]{style="color:#d69c3c"}

[Using the same font size as the **4.1.2** plot, the text for this grid facet chart became smaller, which made it difficult to view. Hence, this chart will not be considered for the final submission.]{style="color:#d69c3c"}
:::

## **4.2 Explore Other Approach**

### **4.2.1 Approach #1 - Stack Multiple Grid Facets**

::: {.callout-warning appearance="simple" icon="false"}
There are 2 parts to this approach :

-   1st part - plot 3 grid facets of population pyramids

-   2nd part - stack the 3 grid facets with ggarrange( ) function from ggpubr package.

#### **4.2.1.1 plot 3 facet grids**

::: panel-tabset
## **Top 3 PAs**

```{r}
#| fig-height: 5
#| fig-width: 12
popPyr_t3 <- ggplot(t3_filtered,
                    aes(x = ifelse(sex == "Males",
                                   yes = -count_pop,
                                   no = count_pop),
                        y = ag,
                        fill = sex),
                    width = 0.9,
                    position = position_dodge(width = 0.9 )) + 
  geom_col() +
  scale_y_discrete(expand = expansion(mult = c(0, .05))) +
  scale_fill_manual(values = c("Males" = "#FFA319FF",
                               "Females" = "#302f2f")) +
  facet_grid(~factor(pa, levels = c("Bedok", "Tampines", "Jurong West"))) +
  scale_x_continuous(limits = c(-13000, 13000),
                     expand = expansion(mult = c(0, .04))) +
  labs (x = "", 
        y = "Age Group",
        title = "Singapore Demographic Structure - Top 9 Planning Areas by Population",
        subtitle = "Compare the population pyramids' shapes that shows the distribution of age groups & genders based on dataset dated June 2022") +
  theme_bw() +
  theme(plot.title = element_text(size = 20, 
                                  colour = "#302f2f",
                                  face = "bold"),
        plot.subtitle = element_text(size = 12,
                                     colour = "#424242",
                                     face = "italic"),
        plot.caption = element_text(size = 10,
                                    colour = "#424242",
                                    hjust = 0),
        strip.text = element_text(size = 12,
                                  face = "bold",
                                  colour = "#424242"),
        strip.background = element_blank(),

        axis.ticks = element_line(colour = "#969595",
                                  linewidth = 0.3),
        axis.ticks.x = element_blank(),
        axis.title.y = element_text(angle = 0, 
                                    size = 10,
                                    face = "bold",
                                    colour = "#302f2f",
                                    vjust = 1.04,
                                    hjust = 0.9,
                                    margin = margin(r = -40, l = 20)),
        axis.title.x = element_text(size = 10, 
                                    colour = "#302f2f"),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 9,
                                   colour = "#424242"),
        panel.grid.major = element_line(linewidth = rel(0.5)),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill = "#f7e9cd"),
        panel.border = element_rect(colour = "#969595",
                                    linewidth = 0.3),
        plot.margin = margin(0.5,0.5,0.1,-0.2,"cm"),
        legend.position = "none")

popPyr_t3
```

## **Between Top 4 to 6 PAs**

```{r}
#| fig-height: 5
#| fig-width: 12
popPyr_t6 <- ggplot(t6_filtered, 
                       aes(x = ifelse(sex == "Males",
                                      yes = -count_pop,
                                      no = count_pop),
                           y = ag,
                           fill = sex),
                     width = 0.9,
                     position = position_dodge(width = 0.9 )) + 
  geom_col() +
  scale_y_discrete(expand = expansion(mult = c(0, .05))) +
  scale_fill_manual(
    values = c("Males" = "#FFA319FF",
               "Females" = "#302f2f")) +
  facet_grid(~factor(pa, levels = c("Sengkang", "Woodlands", "Hougang"))) +
  scale_x_continuous(limits = c(-13000, 13000),
                     expand = expansion(mult = c(0, .04))) +
  theme_bw() +
  theme(strip.text = element_text(size = 12,
                                  face = "bold",
                                  colour = "#424242"),
        strip.background = element_blank(),
        axis.ticks = element_line(colour = "#969595",
                                  linewidth = 0.3),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 9,
                                   colour = "#424242"),
        panel.grid.major = element_line(linewidth = rel(0.5)),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill = "#f7e9cd"),
        panel.border = element_rect(colour = "#969595",
                                    linewidth = 0.3),
        plot.margin = margin(0.1,0.5,0.5,0.5,"cm"),
        legend.position = "none")

popPyr_t6
```

## **Between Top 7 to 9 PAs**

```{r}
#| fig-height: 5
#| fig-width: 12
popPyr_t9 <- ggplot(t9_filtered, 
                       aes(x = ifelse(sex == "Males",
                                      yes = -count_pop,
                                      no = count_pop),
                           y = ag,
                           fill = sex),
                     width = 0.9,
                     position = position_dodge(width = 0.9 )) + 
  geom_col() +
  scale_y_discrete(expand = expansion(mult = c(0, .05))) +
  scale_fill_manual(
    values = c("Males" = "#FFA319FF",
               "Females" = "#302f2f")) +
  facet_grid(~factor(pa, levels = c("Yishun", "Choa Chu Kang", "Punggol")))+
  scale_x_continuous(limits = c(-13000, 13000),
                     expand = expansion(mult = c(0, .04))) +
  labs (x = "Count of Population",
        fill = "Gender",
        caption = "Data Source : Singstat.gov.sg, June 2022") +
  theme_bw() +
  theme(plot.caption = element_text(size = 10,
                                    colour = "#424242",
                                    hjust = 0),
        strip.text = element_text(size = 12,
                                  face = "bold",
                                  colour = "#424242"),
        strip.background = element_blank(),
        axis.ticks = element_line(colour = "#969595",
                                  linewidth = 0.3),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size = 10, 
                                    face = "bold",
                                    colour = "#302f2f"),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 9,
                                   colour = "#424242"),
        panel.grid.major = element_line(linewidth = rel(0.5)),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        plot.background = element_rect(fill = "#f7e9cd"),
        panel.border = element_rect(colour = "#969595",
                                    linewidth = 0.3),
        plot.margin = margin(0.1,0.5,0.5,0.5,"cm"),
        legend.position = "bottom",
        legend.justification = "left",
        legend.title = element_text(size = 12,
                                    face = "bold",
                                    colour = "#302f2f"),
        legend.text = element_text(size = 10,
                                   colour = "#424242"),        
        legend.background = element_rect(fill = "#f7e9cd"),
        legend.margin = margin(t = -10),)

popPyr_t9
```
:::

#### **4.2.1.2 stack 3 grid facets into 1 column**

```{r}
#| fig-height: 12
#| fig-width: 12
#| code-fold: false
ggpubr::ggarrange(
  popPyr_t3,
  popPyr_t6,
  popPyr_t9,
  align = "v",
  ncol = 1)
```

[Remark :]{style="color:#d69c3c"}

[The end result of this approach is as good as the wrap facet approach in **4.1.2**, except there are 2 lines of gap that are unable to get rid of within the due time. When extra free time is available, will attempt to overlap them by changing the margin value.]{style="color:#d69c3c"}
:::

### **4.2.2 Approach #2 - Patch 1 chart with 1 data table**

::: {.callout-warning appearance="simple" icon="false"}
This approach explores using patchwork function to combine chart and table.

```{r}
#| code-fold: false
#| eval: false
#| fig-height: 100
#| fig-width: 12
popPyr_t3 / (gridExtra::tableGrob(t19_filtered[1:342, 
                                               c("pa", "ag", "sex", "count_pop")]))
```

[Remark :]{style="color:#d69c3c"}

::: {.callout-warning collapse="true" appearance="simple" icon="false"}
## [**Issues with this approach**]{style="color:#d69c3c"}

[Figure height was set to 100 via #\| fig-height: 100, but :]{style="color:#d69c3c"}

-   [the displays are overlapping.]{style="color:#d69c3c"}

-   [the chart is elongated out of proportion.]{style="color:#d69c3c"}

![](images/image-329313405.png)
:::
:::

### **4.2.3 Approach #3 - Split data table to smaller tables before patch with 1 chart**

::: {.callout-warning appearance="simple" icon="false"}
Based on **4.2.2** approach, this attempt is to break down the table so that the layouts are more manageable.

```{r}
group_paAg <- t19_filtered %>%
  group_by(pa, ag) %>%
  pivot_wider(id_cols = c(pa, ag),
              names_from = sex,
              values_from = count_pop)

table_top3 <- group_paAg %>%
  filter(pa == "Bedok" | pa == "Tampines" | pa == "Jurong West") %>%
  arrange(factor(pa, levels = c("Bedok", "Tampines", "Jurong West")))

table_top6 <- group_paAg %>%
  filter(pa == "Sengkang" | pa == "Woodlands" | pa == "Hougang") %>%
  arrange(factor(pa, levels = c("Sengkang", "Woodlands", "Hougang")))

table_top9 <- group_paAg %>%
  filter(pa == "Yishun" | pa == "Choa Chu Kang" | pa == "Punggol") %>%
  arrange(factor(pa, levels = c("Yishun", "Choa Chu Kang", "Punggol")))
```

```{r}
#| eval: false
#| code-fold: false
#| fig-height: 100
#| fig-width: 12

popPyr_t3 / (table1_1 | table1_2 | table1_3)
```

[Remark :]{style="color:#d69c3c"}

[Below is the error message when using patchwork function to place the tables below the chart.]{style="color:#d69c3c"}

" [Error in FUN(left, right) : operations are possible only for numeric, logical or complex types]{style="color:#d69c3c"} "
:::

### **4.2.4 Approach #4 - Same as Approach #3 but with kableExtra package**

::: {.callout-warning appearance="simple" icon="false"}
```{r}
#| code-fold: false
#| fig-height: 30
#| fig-width: 20
table_display <- kable(list(table_top3, table_top6, table_top9), "html") %>%
  kable_styling(font_size = 10, 
                full_width = F) %>%
  column_spec(1, border_right = T, background = "#e8e3e3") %>%
  column_spec(2, border_right = T, background  = "#e8e3e3") %>%
  column_spec(3, background  = "#e8e3e3") %>%
  scroll_box(width = "700px", height = "200px")

table_display
```

```{r}
#| eval: false
#| code-fold: false
popPyr_t3 / table_display
```

[Remark :]{style="color:#d69c3c"}

[Below is the error message when using patchwork function to place the kable tables below the chart.]{style="color:#d69c3c"}

" [Error in \`ggplot_add()\`:]{style="color:#d69c3c"}

[! Can't add \`e2\` to a \<ggplot\> object.]{style="color:#d69c3c"} "
:::

### **4.2.5 Approach #5** Combine chart with ggpubr tables

::: {.callout-warning appearance="simple" icon="false"}
There are 3 parts to this approach :

-   1st part - create tables with ggtexttable( ) function from the ggpubr package.

-   2nd part - align the 3 tables horizontally with ggarrange( ).

-   3rd part - place the 2nd part below the trellis plot of **4.1.2**.

#### **4.2.5.1 create gg tables**

```{r}
#| code-fold: false
table_t3 <- ggtexttable(table_top3, rows = NULL, theme = ttheme("mOrange"))
table_t6 <- ggtexttable(table_top6, rows = NULL, theme = ttheme("mOrange"))
table_t9 <- ggtexttable(table_top9, rows = NULL, theme = ttheme("mOrange"))
```

#### **4.2.5.2 align gg tables horizontally**

```{r}
#| code-fold: false
#| fig-height: 16
#| fig-width: 12
tables <- ggarrange(table_t3, table_t6, table_t9,
                    nrow = 1, ncol = 3, align = "h")

tables
```

#### **4.2.5.3 align trellis plot with the tables vertically**

```{r}
#| code-fold: false
#| fig-height: 32
#| fig-width: 12
ggarrange(popPyr_t19.fw,
          NULL,
          tables, 
          ncol = 1, 
          nrow = 3, 
          align = "v",
          heights = c(1, 0, 1)) +
  theme(plot.margin = margin(0.5,0,0.5,0, "cm"))
```

[Remark :]{style="color:#d69c3c"}

[To keep the readers' focus on the chart's context, all the x-axis values and other information details displayed in **4.1.1** are removed from the trellis plot. Those removed information can be referred to in the chart below.]{style="color:#d69c3c"}
:::

# **5. MAKEOVER SUBMISSION**

::: {.callout-warning appearance="simple" icon="false"}
Below is the makeover output for this assignment submission.

```{r}
#| fig-height: 32
#| fig-width: 12
ggarrange(popPyr_t19.fw,
          NULL,
          tables, 
          ncol = 1, 
          nrow = 3, 
          align = "v",
          heights = c(1, 0.02, 1)) +
  theme(plot.margin = margin(0.5,0,0.5,0, "cm"))
```
:::
